<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>BGENG AS | Artificial Singularity</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap');
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --bg-color: #0e0e10; --sidebar-bg: #171719; --accent-color: #2f2f2f; }
        html, body { background-color: var(--bg-color); margin: 0; padding: 0; height: 100%; width: 100%; overflow: hidden; font-family: 'Plus Jakarta Sans', sans-serif; color: #e3e3e3; }
        #sidebar { position: fixed; left: -100%; top: 0; width: 85%; max-width: 300px; height: 100%; background: var(--sidebar-bg); z-index: 100; transition: 0.3s ease; border-right: 1px solid rgba(255,255,255,0.1); display: flex; flex-direction: column; padding: 1.5rem 1rem; }
        #sidebar.open { left: 0; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: none; z-index: 90; backdrop-filter: blur(4px); }
        .app-wrapper { width: 100%; max-width: 1000px; margin: 0 auto; height: 100%; display: flex; flex-direction: column; position: relative; }
        header { padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .chat-container { flex: 1; overflow-y: auto; padding: 1rem; display: flex; flex-direction: column; }
        .chat-bubble { margin-bottom: 2rem; width: 100%; animation: fadeIn 0.4s ease; }
        .user-bubble { align-self: flex-end; width: auto; max-width: 90%; }
        .user-bubble .content { background: var(--accent-color); padding: 0.8rem 1rem; border-radius: 1.2rem; }
        .ai-bubble { align-self: flex-start; width: 100%; padding-top: 1.2rem; }
        .ai-bubble .content { line-height: 1.7; color: #e3e3e3; }
        .thinking-txt { font-size: 0.8rem; color: #4a90e2; font-weight: 500; }
        footer { padding: 1rem; background: var(--bg-color); }
        .input-dock { background: #1e1e20; border-radius: 24px; padding: 0.5rem 0.8rem; display: flex; align-items: center; gap: 0.5rem; border: 1px solid rgba(255,255,255,0.05); }
        #user-input { flex: 1; background: transparent; border: none; outline: none; color: #fff; padding: 0.6rem 0.5rem; }
        .send-circle { width: 36px; height: 36px; border-radius: 50%; background: #4a90e2; color: #000; display: flex; align-items: center; justify-content: center; }
        img { max-width: 100%; border-radius: 12px; margin-top: 10px; border: 1px solid #333; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar()"></div>
<div id="sidebar">
    <div class="flex justify-between items-center mb-6">
        <h2 class="font-bold text-white text-lg">History</h2>
        <button onclick="toggleSidebar()"><i class="fas fa-times text-gray-500"></i></button>
    </div>
    <div id="history-container" class="overflow-y-auto flex-1"></div>
</div>

<div class="app-wrapper">
    <header>
        <div class="flex items-center gap-3">
            <button onclick="toggleSidebar()" class="text-gray-400 p-2"><i class="fas fa-bars"></i></button>
            <div class="font-bold">BGENG <span class="text-blue-500">PREDATOR-X</span></div>
        </div>
        <div id="provider-badge" class="text-[9px] bg-blue-900/30 text-blue-400 px-3 py-1 rounded-full uppercase">Standby</div>
    </header>

    <main id="chat-window" class="chat-container"></main>

    <footer>
        <div class="input-dock">
            <input id="user-input" type="text" placeholder="Analyze or Generate Image..." autocomplete="off">
            <button onclick="sendMsg()" class="send-circle"><i class="fas fa-arrow-up"></i></button>
        </div>
        <p class="text-[9px] text-center text-gray-700 mt-4 tracking-widest uppercase">Singularity v6.0 Predator Protocol</p>
    </footer>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const inputField = document.getElementById('user-input');
    const badge = document.getElementById('provider-badge');
    let userName = localStorage.getItem('bgeng_user_name') || "Der";

    async function sendMsg() {
        const msg = inputField.value.trim();
        if(!msg) return;

        appendBubble('user', msg);
        inputField.value = '';
        badge.innerText = "CLAWING...";
        
        const tid = 't-' + Date.now();
        appendBubble('ai', 'BGENG Thinking...', tid);

        try {
            const res = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg, user_name: userName, history: "" })
            });
            const data = await res.json();
            badge.innerText = data.provider;
            document.getElementById(tid).innerHTML = '';
            typeEffect(tid, data.reply);
        } catch (e) {
            document.getElementById(tid).innerText = "Koneksi bapuk Der.";
        }
    }

    function typeEffect(id, text) {
        let i = 0;
        const target = document.getElementById(id);
        function type() {
            if (i < text.length) {
                target.innerHTML = marked.parse(text.substring(0, i + 1));
                target.querySelectorAll('pre code').forEach(el => hljs.highlightElement(el));
                i++;
                setTimeout(type, 1);
                if(i % 5 === 0) chatWindow.scrollTo(0, chatWindow.scrollHeight);
            }
        }
        type();
    }

    function appendBubble(role, text, id = '') {
        const d = document.createElement('div');
        d.className = `chat-bubble ${role}-bubble`;
        d.innerHTML = `<div class="content" id="${id}">${role === 'user' ? text : marked.parse(text)}</div>`;
        chatWindow.appendChild(d);
        chatWindow.scrollTo(0, chatWindow.scrollHeight);
    }

    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('sidebar-overlay').style.display = document.getElementById('sidebar').classList.contains('open') ? 'block' : 'none';
    }

    inputField.addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMsg(); });
</script>
</body>
</html>
